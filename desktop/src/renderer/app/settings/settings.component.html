<div class="h-full flex bg-gray-50 text-sm">
    <!-- Left Sidebar: Navigation -->
    <div class="w-64 bg-white border-r border-gray-200 flex flex-col">
        <div class="p-6 border-b border-gray-100">
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <span>Admin</span> Center
            </h1>
            <p class="text-xs text-gray-400 mt-1">System Configuration</p>
        </div>

        <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
            <button (click)="activeTab = 'general'"
                [class]="activeTab === 'general' ? 'bg-blue-50 text-blue-700 border-blue-500' : 'text-gray-600 hover:bg-gray-50 border-transparent'"
                class="w-full text-left px-3 py-2 rounded-md transition-colors font-medium flex items-center gap-3 border-l-4">
                <span>General</span>
            </button>

            <ng-container *ngIf="currentUser?.role === 'admin'">
                <button (click)="activeTab = 'users'"
                    [class]="activeTab === 'users' ? 'bg-blue-50 text-blue-700 border-blue-500' : 'text-gray-600 hover:bg-gray-50 border-transparent'"
                    class="w-full text-left px-3 py-2 rounded-md transition-colors font-medium flex items-center gap-3 border-l-4">
                    <span>Users</span>
                </button>

                <button (click)="activeTab = 'security'"
                    [class]="activeTab === 'security' ? 'bg-blue-50 text-blue-700 border-blue-500' : 'text-gray-600 hover:bg-gray-50 border-transparent'"
                    class="w-full text-left px-3 py-2 rounded-md transition-colors font-medium flex items-center gap-3 border-l-4">
                    <span>Security</span>
                </button>

                <button (click)="activeTab = 'backup'" *ngIf="isElectron"
                    [class]="activeTab === 'backup' ? 'bg-blue-50 text-blue-700 border-blue-500' : 'text-gray-600 hover:bg-gray-50 border-transparent'"
                    class="w-full text-left px-3 py-2 rounded-md transition-colors font-medium flex items-center gap-3 border-l-4">
                    <span>Data & Backup</span>
                </button>

                <button (click)="loadAuditLogs(); activeTab = 'audit'"
                    [class]="activeTab === 'audit' ? 'bg-blue-50 text-blue-700 border-blue-500' : 'text-gray-600 hover:bg-gray-50 border-transparent'"
                    class="w-full text-left px-3 py-2 rounded-md transition-colors font-medium flex items-center gap-3 border-l-4">
                    <span>Audit Logs</span>
                </button>
            </ng-container>
        </nav>

        <div class="p-4 border-t text-xs text-gray-400">
            NalamDesk v{{ appVersion || '1.0.0' }}
        </div>
    </div>

    <!-- Right Content: Workspaces -->
    <div class="flex-1 flex flex-col overflow-hidden">

        <!-- 1. GENERAL TAB -->
        <div *ngIf="activeTab === 'general'" class="h-full overflow-y-auto p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Clinic Details</h2>

            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                <form (ngSubmit)="saveSettings()">
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Clinic Name</label>
                            <input [(ngModel)]="settings.clinic_name" name="clinic_name"
                                class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                        </div>
                    </div>
                    <div class="mt-6 flex items-center gap-4">
                        <button type="submit" class="btn btn-primary px-6">Save Changes</button>
                        <span *ngIf="settingsSaved" class="text-green-600 text-sm font-medium animate-pulse">✓ Saved
                            successfully!</span>
                    </div>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200" *ngIf="isElectron">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-medium text-purple-700">Online Booking</h3>
                        <p class="text-sm text-gray-500">Enable public appointment booking on nalamdesk.com</p>
                    </div>
                    <input type="checkbox" class="toggle toggle-primary" [checked]="cloudEnabled"
                        (change)="toggleCloud($event)" />
                </div>
                <div *ngIf="cloudClinicId"
                    class="bg-purple-50 p-3 rounded border border-purple-100 text-purple-800 text-sm">
                    <strong>Status:</strong> Active &bull; <strong>Clinic ID:</strong> {{ cloudClinicId }}
                </div>
            </div>
        </div>

        <!-- 2. USERS TAB -->
        <div *ngIf="activeTab === 'users'" class="h-full flex flex-col">
            <!-- Header -->
            <div class="flex-none px-8 pt-8 pb-4 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Users</h2>
                    <p class="text-gray-500 text-sm">Manage access, roles, and employee profiles.</p>
                </div>
                <button (click)="editUser({})" class="btn btn-primary text-sm">
                    + Add User
                </button>
            </div>

            <!-- AG Table Container -->
            <div class="flex-1 min-h-0 overflow-hidden px-8 pb-8">
                <app-shared-table [rowData]="filteredUsersForGrid" [columnDefs]="userColumnDefs" [pagination]="true"
                    [pageSize]="20" [quickFilterText]="searchTerm">

                    <div toolbar-left class="flex items-center gap-4">
                        <!-- Role Filter (Pills) -->
                        <div class="flex gap-2">
                            <button *ngFor="let r of ['All', 'Admin', 'Doctor', 'Nurse', 'Receptionist']"
                                (click)="staffFilter = r.toLowerCase()"
                                [class]="staffFilter === r.toLowerCase() ? 'bg-blue-50 text-blue-700 ring-1 ring-blue-500 font-medium' : 'text-gray-600 hover:bg-gray-100'"
                                class="px-3 py-1.5 rounded-md text-xs transition-all border border-transparent">
                                {{ r }}
                            </button>
                        </div>

                        <div class="h-4 w-px bg-gray-300 mx-2"></div>

                        <!-- Search -->
                        <div class="relative group">
                            <span
                                class="absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-blue-500">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                                </svg>
                            </span>
                            <input [(ngModel)]="searchTerm" placeholder="Search..."
                                class="pl-8 pr-3 py-1.5 text-xs border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 w-48 shadow-sm transition-all">
                        </div>
                    </div>

                </app-shared-table>
            </div>
        </div>

        <!-- 3. SECURITY TAB -->
        <div *ngIf="activeTab === 'security'" class="h-full overflow-y-auto p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Security & Resilience</h2>

            <!-- Recovery Code -->
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-medium text-red-600">Master Recovery Code</h3>
                        <p class="text-sm text-gray-500 max-w-lg">Used to regain access if the admin password is lost.
                            Store this securely offline.</p>
                        <p class="text-xs text-red-500 mt-2 font-bold bg-red-50 inline-block px-2 py-1 rounded">⚠️
                            Generating a new code immediately invalidates the old one.</p>
                    </div>
                    <button (click)="openRecoveryModal()" class="btn btn-outline btn-error">Generate New Code</button>
                </div>
            </div>
        </div>

        <!-- 4. BACKUP TAB -->
        <div *ngIf="activeTab === 'backup'" class="h-full overflow-y-auto p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Data Redundancy</h2>

            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-medium text-blue-600 flex items-center gap-2">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/1/12/Google_Drive_icon_%282020%29.svg"
                                class="w-5 h-5">
                            Google Drive Backup
                        </h3>
                        <p class="text-sm text-gray-500">Securely sync encrypted database snapshots to your cloud.</p>
                    </div>
                    <button (click)="connectDrive()" [disabled]="isLoading" class="btn btn-primary btn-sm">
                        {{ isLoading ? 'Connecting...' : 'Connect Drive' }}
                    </button>
                </div>

                <div *ngIf="message" class="mb-4 text-sm font-medium"
                    [ngClass]="{'text-green-600': success, 'text-red-500': !success}">
                    Status: {{ message }}
                </div>

                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-medium text-gray-700">Snapshot History</h4>
                        <div class="flex gap-2">
                            <button (click)="listBackups()"
                                class="text-blue-600 text-xs hover:underline">Refresh</button>
                            <button (click)="backupNow()" [disabled]="isBackupLoading"
                                class="bg-green-50 text-green-700 text-xs px-3 py-1 rounded border border-green-200 hover:bg-green-100 font-bold">
                                {{ isBackupLoading ? 'Uploading...' : 'Create Snapshot Now' }}
                            </button>
                        </div>
                    </div>

                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        <ng-container *ngIf="backups.length > 0; else noBackups">
                            <div *ngFor="let file of backups"
                                class="flex items-center justify-between p-3 bg-gray-50 rounded border hover:bg-white transition-colors">
                                <div>
                                    <p class="font-medium text-gray-800 text-sm">{{ file.name }}</p>
                                    <p class="text-xs text-gray-500">{{ file.createdTime | date:'medium' }}</p>
                                </div>
                                <button (click)="restore(file.id)"
                                    class="text-red-600 border border-red-200 px-3 py-1 rounded hover:bg-red-50 text-xs font-medium">
                                    Restore
                                </button>
                            </div>
                        </ng-container>
                        <ng-template #noBackups>
                            <div class="text-center py-8 text-gray-400 italic text-sm border-2 border-dashed rounded">
                                No backups found. Connect Drive and create your first snapshot.
                            </div>
                        </ng-template>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. AUDIT TAB -->
        <div *ngIf="activeTab === 'audit'" class="h-full flex flex-col p-8">
            <h2 class="flex-none text-2xl font-bold text-gray-800 mb-6">Audit Logs</h2>
            <div class="flex-1 min-h-0 overflow-hidden">
                <app-shared-table [rowData]="auditLogs" [columnDefs]="auditColumnDefs" [pagination]="true"
                    [pageSize]="50">
                </app-shared-table>
            </div>
        </div>

    </div>
</div>

<!-- USER FORM MODAL -->
<div *ngIf="editingUser" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg max-h-[90vh] flex flex-col">
        <!-- Sticky Header -->
        <div class="flex-none p-4 border-b flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800">{{ editingUser.id ? 'Edit User' : 'Add User' }}</h3>
            <button (click)="editingUser = null" class="text-gray-400 hover:text-gray-600">✕</button>
        </div>

        <!-- Scrollable Body -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Account Info -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Username <span
                            class="text-red-500">*</span></label>
                    <input [(ngModel)]="editingUser.username" #username="ngModel" required minlength="3"
                        [disabled]="editingUser.id"
                        [class.border-red-500]="(username.invalid && (username.dirty || username.touched)) || (formSubmitted && !editingUser.username)"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2 bg-gray-50 disabled:text-gray-400">
                    <p *ngIf="username.invalid && (username.dirty || username.touched)"
                        class="text-xs text-red-500 mt-1">
                        Min 3 alphanumeric characters required.
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">System Role <span
                            class="text-red-500">*</span></label>
                    <select [(ngModel)]="editingUser.role" required #role="ngModel"
                        [class.border-red-500]="(role.invalid && role.touched) || (formSubmitted && !editingUser.role)"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                        <option value="doctor">Doctor</option>
                        <option value="nurse">Nurse</option>
                        <option value="receptionist">Receptionist</option>
                        <option value="admin">Admin</option>
                    </select>
                    <p *ngIf="role.invalid && role.touched" class="text-xs text-red-500 mt-1">Role is required.</p>
                </div>
            </div>

            <!-- Personal Info -->
            <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Full Name <span
                            class="text-red-500">*</span></label>
                    <input [(ngModel)]="editingUser.name" required minlength="2" #name="ngModel"
                        [class.border-red-500]="(name.invalid && (name.dirty || name.touched)) || (formSubmitted && !editingUser.name)"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                    <p *ngIf="name.invalid && (name.dirty || name.touched)" class="text-xs text-red-500 mt-1">
                        Full Name is required.
                    </p>
                </div>

                <!-- DOB -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
                    <app-date-picker [(ngModel)]="editingUser.dob" placeholder="Select DOB"></app-date-picker>
                </div>

                <!-- Joining Date -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Joining Date</label>
                    <app-date-picker [(ngModel)]="editingUser.joining_date"
                        placeholder="Select Joining Date"></app-date-picker>
                </div>

                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Designation / Title</label>
                    <input [(ngModel)]="editingUser.designation" placeholder="e.g. Senior Nurse"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                </div>
            </div>

            <!-- Contact Info -->
            <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Mobile Number</label>
                    <input [(ngModel)]="editingUser.mobile" #mobile="ngModel" pattern="^[0-9]{10}$"
                        [class.border-red-500]="mobile.invalid && (mobile.dirty || mobile.touched)"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                    <p *ngIf="mobile.invalid && (mobile.dirty || mobile.touched)" class="text-xs text-red-500 mt-1">
                        Must be exactly 10 digits.
                    </p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input [(ngModel)]="editingUser.email" #email="ngModel" type="email"
                        pattern="^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$"
                        [class.border-red-500]="email.invalid && (email.dirty || email.touched)"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">
                    <p *ngIf="email.invalid && (email.dirty || email.touched)" class="text-xs text-red-500 mt-1">
                        Invalid email format.
                    </p>
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Residential Address</label>
                    <textarea [(ngModel)]="editingUser.address" rows="2"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2"></textarea>
                </div>
            </div>

            <!-- Password & Status -->
            <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                <div>
                    <label class="block text-sm font-medium text-gray-700">
                        {{ editingUser.id ? 'Reset Password' : 'Password' }} <span *ngIf="!editingUser.id"
                            class="text-red-500">*</span>
                    </label>
                    <input [(ngModel)]="editingUser.password" type="password" placeholder="Set temporary password"
                        #password="ngModel" [required]="!editingUser.id" minlength="4"
                        [class.border-red-500]="(password.invalid && (password.dirty || password.touched)) || (formSubmitted && !editingUser.id && !editingUser.password)"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border p-2">

                    <p *ngIf="password.invalid && (password.dirty || password.touched)"
                        class="text-xs text-red-500 mt-1">
                        Min 4 characters required.
                    </p>
                    <p class="text-xs text-gray-500 mt-1" *ngIf="editingUser.password && editingUser.id">User will
                        be forced to change this on next login.</p>
                </div>
                <div class="flex-1">
                    <label class="flex items-center gap-2 text-sm font-medium text-gray-700 mt-6 cursor-pointer">
                        <input type="checkbox" [ngModel]="editingUser.active === 0"
                            (ngModelChange)="editingUser.active = $event ? 0 : 1" [ngModelOptions]="{standalone: true}"
                            class="rounded border-gray-300 text-red-600 focus:ring-red-500 h-4 w-4">
                        <span [class.text-red-600]="editingUser.active === 0">Disable User</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Sticky Footer -->
        <div class="flex-none p-4 bg-gray-50 border-t flex justify-end gap-3">
            <button (click)="editingUser = null" class="btn btn-ghost">Cancel</button>
            <button (click)="saveUser()" class="btn btn-primary">
                {{ editingUser.id ? 'Save Changes' : 'Add User' }}
            </button>
        </div>
    </div>
</div>

<!-- CLOUD MODAL (Legacy) -->
<div *ngIf="showCloudModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-sm">
        <h3 class="text-xl font-bold mb-2">Setup Online Booking</h3>
        <p class="text-sm text-gray-500 mb-4">Register your clinic on our public directory.</p>
        <div class="space-y-4">
            <div><label class="block text-sm font-medium text-gray-700">Clinic Name (Public)</label><input
                    [(ngModel)]="cloudForm.name" class="input input-bordered w-full"></div>
            <div><label class="block text-sm font-medium text-gray-700">City</label><input [(ngModel)]="cloudForm.city"
                    class="input input-bordered w-full"></div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
            <button (click)="showCloudModal = false" class="btn btn-ghost" [disabled]="cloudLoading">Cancel</button>
            <button (click)="submitCloudOnboard()" class="btn btn-primary" [disabled]="cloudLoading">{{ cloudLoading ?
                'Registering...' : 'Enable' }}</button>
        </div>
    </div>
</div>

<!-- RECOVERY MODAL -->
<div *ngIf="showRecoveryModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-xl font-bold mb-4">Generate Recovery Code</h3>
        <div *ngIf="!newRecoveryCode">
            <p class="text-sm text-gray-600 mb-4">Enter Master Password to confirm.</p>
            <input type="password" [(ngModel)]="confirmPassword" class="input input-bordered w-full mb-4"
                placeholder="Master Password">
            <div class="flex justify-end gap-2">
                <button (click)="showRecoveryModal = false" class="btn btn-ghost">Cancel</button>
                <button (click)="generateRecoveryCode()" class="btn btn-error"
                    [disabled]="!confirmPassword || isLoading">{{ isLoading ? 'Processing...' : 'Generate' }}</button>
            </div>
        </div>
        <div *ngIf="newRecoveryCode">
            <div class="bg-gray-100 p-4 rounded text-center mb-4 border border-gray-300">
                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">New Code</p>
                <p class="text-xl font-mono font-bold select-all text-red-600">{{ newRecoveryCode }}</p>
                <button (click)="copyRecoveryCode()" class="btn btn-xs btn-outline mt-2">{{ isCopied ? 'Copied!' : 'Copy
                    to Clipboard' }}</button>
            </div>
            <div class="flex justify-center"><button (click)="closeRecoveryModal()"
                    class="btn btn-primary">Done</button></div>
        </div>
    </div>
</div>